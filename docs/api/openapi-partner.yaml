openapi: 3.0.3
info:
  title: DeFarm Engines API - Partner Integration
  version: 1.0.0
  description: |
    API simplificada para integração de parceiros DeFarm.

    ## Funcionalidades Principais
    - **Autenticação JWT** - Login seguro com token
    - **API Keys** - Gerar chaves de API para integração server-to-server
    - **Circuitos** - Repositórios de dados com permissões
    - **Itens** - Criação e tokenização de itens (DFID)
    - **Eventos** - Registro de eventos e histórico
    - **Adapters** - Configuração de storage (IPFS, Stellar)

    ## Autenticação
    Use o token JWT no header:
    ```
    Authorization: Bearer <seu-token-jwt>
    ```

    Ou chave de API:
    ```
    X-API-Key: dfm_<sua-chave>
    ```
  contact:
    name: DeFarm API Support
    email: api@defarm.net

servers:
  - url: https://connect.defarm.net/api
    description: Servidor de Produção

tags:
  - name: Authentication
    description: Autenticação e gerenciamento de tokens JWT
  - name: API Keys
    description: Gerenciamento de chaves de API para integração
  - name: Circuits
    description: Gerenciamento de circuitos e operações (push/pull)
  - name: Items
    description: Criação, tokenização e gerenciamento de itens
  - name: Events
    description: Tracking de eventos e histórico
  - name: Storage History
    description: Histórico de armazenamento e localização
  - name: Adapters
    description: Configuração de adapters de storage

security:
  - BearerAuth: []
  - ApiKeyAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtido via /auth/login

    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Chave de API no formato dfm_<32-caracteres>

  schemas:
    # ============================================================================
    # Authentication Schemas
    # ============================================================================

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: "cowpro"
        password:
          type: string
          format: password
          example: "CowPro2024Test@123"

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT token para autenticação
        user_id:
          type: string
          format: uuid
        workspace_id:
          type: string
        expires_at:
          type: integer
          format: int64

    # ============================================================================
    # API Key Schemas
    # ============================================================================

    CreateApiKeyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Nome descritivo da chave
          example: "Integração CowPro Produção"
        permissions:
          type: object
          properties:
            read:
              type: boolean
              default: true
            write:
              type: boolean
              default: true
          description: Permissões da chave
        expires_at:
          type: string
          format: date-time
          description: Data de expiração (opcional)
        ip_restrictions:
          type: array
          items:
            type: string
          description: Lista de IPs permitidos (opcional)
          example: ["192.168.1.0/24", "10.0.0.1"]

    ApiKeyResponse:
      type: object
      properties:
        key_id:
          type: string
          format: uuid
        key:
          type: string
          description: |
            Chave de API completa (mostrada apenas uma vez!)
            Formato: dfm_<32-caracteres>
          example: "dfm_abc123def456ghi789jkl012mno345pq"
        name:
          type: string
        prefix:
          type: string
          description: Prefixo da chave para identificação
          example: "dfm_abc1"
        permissions:
          type: object
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        is_active:
          type: boolean

    ApiKeyListItem:
      type: object
      properties:
        key_id:
          type: string
          format: uuid
        name:
          type: string
        prefix:
          type: string
          description: Apenas o prefixo (chave completa não é armazenada)
        permissions:
          type: object
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        is_active:
          type: boolean
        last_used_at:
          type: string
          format: date-time

    # ============================================================================
    # Item Schemas
    # ============================================================================

    EnhancedIdentifier:
      type: object
      required:
        - namespace
        - key
        - value
      properties:
        namespace:
          type: string
          description: Namespace do identificador
          enum: [bovino, aves, suino, soja, milho, algodao, cafe, leite, generic]
          example: bovino
        key:
          type: string
          description: Tipo do identificador
          example: sisbov
        value:
          type: string
          description: Valor do identificador
          example: "BR921180523565"
        id_type:
          type: string
          enum: [Canonical, Contextual]
          default: Canonical
        verified:
          type: boolean
          default: false

    CreateLocalItemRequest:
      type: object
      required:
        - identifiers
      properties:
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/EnhancedIdentifier'
          minItems: 1
        enriched_data:
          type: object
          additionalProperties: true
          description: Dados adicionais do item
          example:
            weight: "500kg"
            breed: "Angus"

    LocalItemResponse:
      type: object
      properties:
        local_id:
          type: string
          format: uuid
          description: ID local do item (LID)
        status:
          type: string
          enum: [local, pushed, tokenized]
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/EnhancedIdentifier'
        enriched_data:
          type: object
        created_at:
          type: string
          format: date-time

    # ============================================================================
    # Circuit Schemas
    # ============================================================================

    CircuitResponse:
      type: object
      properties:
        circuit_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        owner_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [Active, Inactive]
        members:
          type: array
          items:
            type: object
            properties:
              member_id:
                type: string
                format: uuid
              role:
                type: string
              permissions:
                type: array
                items:
                  type: string

    CreateCircuitRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: "CowPro Traceability Circuit"
        description:
          type: string
          example: "Circuito de rastreabilidade bovina"
        adapter_config:
          $ref: '#/components/schemas/AdapterConfig'

    PushLocalItemRequest:
      type: object
      required:
        - local_id
      properties:
        local_id:
          type: string
          format: uuid
          description: ID local do item a ser enviado
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/EnhancedIdentifier'

    PushResponse:
      type: object
      properties:
        success:
          type: boolean
        dfid:
          type: string
          description: DFID atribuído ao item
        local_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [new_item, enriched_existing, pending_approval]
        storage:
          $ref: '#/components/schemas/StorageLocation'

    # ============================================================================
    # Adapter Schemas
    # ============================================================================

    AdapterConfig:
      type: object
      properties:
        adapter_type:
          type: string
          enum: [None, StellarTestnetIpfs, StellarMainnetIpfs, IpfsOnly]
          description: |
            Tipo de adapter:
            - None: Sem blockchain (tier Basic)
            - StellarTestnetIpfs: Stellar Testnet + IPFS (tier Professional)
            - StellarMainnetIpfs: Stellar Mainnet + IPFS (tier Enterprise)
        requires_approval:
          type: boolean
          default: false
        auto_migrate_existing:
          type: boolean
          default: false
        sponsor_adapter_access:
          type: boolean
          default: true
          description: Se true, membros usam o adapter do circuito

    StorageLocation:
      type: object
      properties:
        adapter_type:
          type: string
        location:
          type: string
          description: CID do IPFS ou hash de transação
        hash:
          type: string
        stored_at:
          type: string
          format: date-time
        metadata:
          type: object

    # ============================================================================
    # Event Schemas
    # ============================================================================

    Event:
      type: object
      properties:
        event_id:
          type: string
          format: uuid
        dfid:
          type: string
        event_type:
          type: string
          enum: [Created, Enriched, Transferred, Merged, Split, Circuit, Published, Verified]
        timestamp:
          type: integer
          format: int64
        source:
          type: string
        metadata:
          type: object
        visibility:
          type: string
          enum: [Public, Private, CircuitOnly]

    LocalEventResponse:
      type: object
      properties:
        event_id:
          type: string
          format: uuid
        local_event_id:
          type: string
          format: uuid
        event_type:
          type: string
        timestamp:
          type: integer
          format: int64
        source:
          type: string
        metadata:
          type: object
        visibility:
          type: string
        is_local:
          type: boolean

    PushEventsResponse:
      type: object
      properties:
        success:
          type: boolean
        circuit_id:
          type: string
          format: uuid
        events_pushed:
          type: integer
        events_deduplicated:
          type: integer
        events:
          type: array
          items:
            type: object
            properties:
              event_id:
                type: string
              local_event_id:
                type: string
              dfid:
                type: string
              was_deduplicated:
                type: boolean
              was_merged:
                type: boolean
              merged_keys:
                type: array
                items:
                  type: string

    # ============================================================================
    # Storage History Schema
    # ============================================================================

    StorageHistoryResponse:
      type: object
      properties:
        dfid:
          type: string
        history:
          type: array
          items:
            $ref: '#/components/schemas/StorageLocation'

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string

paths:
  # ============================================================================
  # Authentication Endpoints
  # ============================================================================

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login e obter token JWT
      description: Autentica o usuário e retorna um token JWT válido por 24h
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login bem-sucedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciais inválidas

  # ============================================================================
  # API Keys Endpoints
  # ============================================================================

  /api-keys:
    get:
      tags:
        - API Keys
      summary: Listar minhas chaves de API
      description: Retorna todas as chaves de API do usuário autenticado
      operationId: listApiKeys
      responses:
        '200':
          description: Lista de chaves
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  api_keys:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApiKeyListItem'

    post:
      tags:
        - API Keys
      summary: Criar nova chave de API
      description: |
        Cria uma nova chave de API para integração server-to-server.

        **IMPORTANTE:** A chave completa é mostrada apenas UMA VEZ na resposta.
        Guarde-a em local seguro pois não será possível recuperá-la depois.

        **Uso da chave:**
        ```
        X-API-Key: dfm_sua_chave_aqui
        ```

        Ou no header Authorization:
        ```
        Authorization: Bearer dfm_sua_chave_aqui
        ```
      operationId: createApiKey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
            example:
              name: "Integração CowPro Produção"
              permissions:
                read: true
                write: true
      responses:
        '200':
          description: Chave criada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyResponse'
        '400':
          description: Dados inválidos

  /api-keys/{key_id}:
    get:
      tags:
        - API Keys
      summary: Detalhes da chave
      description: Retorna detalhes de uma chave específica (sem a chave completa)
      operationId: getApiKey
      parameters:
        - name: key_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Detalhes da chave
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyListItem'
        '404':
          description: Chave não encontrada

    delete:
      tags:
        - API Keys
      summary: Revogar chave de API
      description: |
        Revoga (desativa) permanentemente uma chave de API.
        A chave não poderá mais ser usada para autenticação.
      operationId: revokeApiKey
      parameters:
        - name: key_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Chave revogada
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          description: Chave não encontrada

  # ============================================================================
  # Items Endpoints
  # ============================================================================

  /items/local:
    post:
      tags:
        - Items
      summary: Criar item local
      description: |
        Cria um item local (LID) que pode ser posteriormente enviado a um circuito.
        O item só recebe um DFID quando é enviado ao circuito (tokenização).
      operationId: createLocalItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLocalItemRequest'
            example:
              identifiers:
                - namespace: bovino
                  key: sisbov
                  value: "BR921180523565"
                  id_type: Canonical
                  verified: false
              enriched_data:
                weight: "520kg"
                breed: "Nelore"
                farm: "Fazenda CowPro"
      responses:
        '200':
          description: Item criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalItemResponse'
        '400':
          description: Dados inválidos
        '401':
          description: Não autenticado

  /items/{dfid}:
    get:
      tags:
        - Items
      summary: Buscar item por DFID
      description: Retorna detalhes de um item tokenizado
      operationId: getItem
      parameters:
        - name: dfid
          in: path
          required: true
          schema:
            type: string
          example: "DFID-20251201-000001-ABCD"
      responses:
        '200':
          description: Item encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  dfid:
                    type: string
                  identifiers:
                    type: array
                    items:
                      $ref: '#/components/schemas/EnhancedIdentifier'
                  enriched_data:
                    type: object
                  status:
                    type: string
        '404':
          description: Item não encontrado

  /items/{dfid}/storage-history:
    get:
      tags:
        - Storage History
      summary: Histórico de armazenamento
      description: |
        Retorna o histórico de armazenamento do item, incluindo:
        - CIDs do IPFS
        - Transações Stellar
        - Timestamps de cada operação
      operationId: getStorageHistory
      parameters:
        - name: dfid
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Histórico encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageHistoryResponse'
        '404':
          description: Item não encontrado

  # ============================================================================
  # Circuits Endpoints
  # ============================================================================

  /circuits:
    get:
      tags:
        - Circuits
      summary: Listar circuitos
      description: Retorna todos os circuitos do usuário
      operationId: listCircuits
      responses:
        '200':
          description: Lista de circuitos
          content:
            application/json:
              schema:
                type: object
                properties:
                  circuits:
                    type: array
                    items:
                      $ref: '#/components/schemas/CircuitResponse'

    post:
      tags:
        - Circuits
      summary: Criar circuito
      description: |
        Cria um novo circuito. O adapter pode ser configurado na criação
        se o usuário tiver o tier apropriado.
      operationId: createCircuit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCircuitRequest'
            example:
              name: "Rastreabilidade CowPro"
              description: "Circuito para rastrear bovinos"
              adapter_config:
                adapter_type: "StellarTestnetIpfs"
                requires_approval: false
                sponsor_adapter_access: true
      responses:
        '200':
          description: Circuito criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '403':
          description: Tier insuficiente para o adapter selecionado

  /circuits/{circuit_id}:
    get:
      tags:
        - Circuits
      summary: Detalhes do circuito
      operationId: getCircuit
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Circuito encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'

  /circuits/{circuit_id}/push-local:
    post:
      tags:
        - Circuits
      summary: Enviar item local para circuito
      description: |
        Envia um item local (LID) para o circuito para tokenização.
        O circuito atribui um DFID baseado na lógica de deduplicação.

        **Deduplicação:**
        - Identificadores canônicos (SISBOV, CPF) são usados primeiro
        - Se não encontrado, um novo DFID é criado
        - Se encontrado, o item existente é enriquecido
      operationId: pushLocalItem
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PushLocalItemRequest'
            example:
              local_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Item enviado e tokenizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PushResponse'
        '403':
          description: Sem permissão de push ou adapter indisponível

  /circuits/{circuit_id}/adapter:
    get:
      tags:
        - Adapters
      summary: Configuração do adapter do circuito
      operationId: getCircuitAdapter
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Configuração do adapter
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/AdapterConfig'

    put:
      tags:
        - Adapters
      summary: Alterar adapter do circuito
      description: |
        Atualiza a configuração do adapter do circuito.
        Apenas owner ou admin do circuito podem alterar.
        O usuário deve ter acesso ao adapter no seu tier.

        **Tiers e Adapters:**
        - Basic: None (sem blockchain)
        - Professional: StellarTestnetIpfs
        - Enterprise: StellarMainnetIpfs
      operationId: updateCircuitAdapter
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdapterConfig'
            example:
              adapter_type: "StellarTestnetIpfs"
              requires_approval: false
              sponsor_adapter_access: true
      responses:
        '200':
          description: Adapter atualizado
        '403':
          description: Sem permissão ou tier insuficiente

  /circuits/{circuit_id}/items:
    get:
      tags:
        - Circuits
      summary: Itens do circuito
      description: Lista todos os itens no circuito
      operationId: getCircuitItems
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Lista de itens
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        dfid:
                          type: string
                        identifiers:
                          type: array
                          items:
                            $ref: '#/components/schemas/EnhancedIdentifier'
                        pushed_at:
                          type: string
                          format: date-time
                  total:
                    type: integer

  # ============================================================================
  # Events Endpoints
  # ============================================================================

  /events:
    get:
      tags:
        - Events
      summary: Listar eventos
      description: Retorna histórico de eventos com filtros opcionais
      operationId: listEvents
      parameters:
        - name: dfid
          in: query
          description: Filtrar por DFID
          schema:
            type: string
        - name: event_type
          in: query
          description: Filtrar por tipo de evento
          schema:
            type: string
        - name: from_time
          in: query
          description: Timestamp inicial (Unix epoch)
          schema:
            type: integer
        - name: to_time
          in: query
          description: Timestamp final (Unix epoch)
          schema:
            type: integer
      responses:
        '200':
          description: Lista de eventos
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'

  /events/local:
    post:
      tags:
        - Events
      summary: Criar evento local
      description: |
        Cria um evento local que ainda não está associado a um DFID.
        Eventos locais podem ser enviados a um circuito posteriormente.

        **Deduplicação:**
        - Eventos são deduplicados por hash de conteúdo (BLAKE3)
        - Ao enviar um evento duplicado, metadata é mesclado automaticamente
      operationId: createLocalEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event_type
                - visibility
              properties:
                event_type:
                  type: string
                  enum: [Created, Enriched, Transferred, Merged, Split, Circuit, Published, Verified]
                visibility:
                  type: string
                  enum: [Public, Private, CircuitOnly]
                metadata:
                  type: object
            example:
              event_type: "Created"
              visibility: "Public"
              metadata:
                action: "registro_inicial"
                location: "Fazenda CowPro"
      responses:
        '200':
          description: Evento criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalEventResponse'

  /events/local/{local_event_id}:
    get:
      tags:
        - Events
      summary: Buscar evento local
      operationId: getLocalEvent
      parameters:
        - name: local_event_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Evento encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocalEventResponse'
        '404':
          description: Evento não encontrado

  /circuits/{circuit_id}/push-events:
    post:
      tags:
        - Events
      summary: Enviar eventos para circuito
      description: |
        Envia eventos locais para um circuito, associando-os a um DFID.

        **Deduplicação automática:**
        - Eventos duplicados são identificados pelo hash de conteúdo
        - Metadata é mesclado automaticamente (apenas novas chaves)
        - Resposta indica quais eventos foram deduplicados/mesclados
      operationId: pushEventsToCircuit
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - local_event_ids
                - dfid
              properties:
                local_event_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                dfid:
                  type: string
            example:
              local_event_ids: ["550e8400-e29b-41d4-a716-446655440000"]
              dfid: "DFID-20251201-000001-ABCD"
      responses:
        '200':
          description: Eventos enviados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PushEventsResponse'
        '403':
          description: Sem permissão de push
