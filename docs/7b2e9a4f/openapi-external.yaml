openapi: 3.0.3
info:
  title: DeFarm Engines - External Integration API
  version: 1.0.0
  description: |
    # DeFarm Engines API for External Integration

    This API enables farm management systems and external applications to integrate with the DeFarm platform
    for blockchain-based item tokenization, decentralized storage, and supply chain tracking.

    ## Key Features

    - **Local Item Creation**: Create items locally before tokenization
    - **Circuit Push**: Tokenize items to blockchain and IPFS through circuits
    - **Storage History**: Track all storage locations and blockchain transactions
    - **Webhooks**: Receive real-time notifications about item lifecycle events

    ## Authentication

    All endpoints (except login/register) require authentication via:
    - **JWT Token**: Include in `Authorization: Bearer <token>` header
    - **API Key**: Include in `X-API-Key: <api_key>` header

    ## Rate Limits

    Rate limits vary by tier:
    - **Basic**: 100 requests/hour
    - **Professional**: 1,000 requests/hour
    - **Enterprise**: 10,000 requests/hour

  contact:
    name: DeFarm API Support
    url: https://defarm.io/support
  license:
    name: Proprietary

servers:
  - url: https://defarm-engines-api-production.up.railway.app
    description: Production server
  - url: http://localhost:3000
    description: Local development server

tags:
  - name: Authentication
    description: User authentication and registration
  - name: Items
    description: Item creation and management
  - name: Circuits
    description: Circuit operations and tokenization
  - name: Storage
    description: Storage history and blockchain tracking
  - name: Adapters
    description: Available storage adapters
  - name: Webhooks
    description: Webhook configuration for event notifications

paths:
  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Authenticate user
      description: Login with username and password to obtain JWT token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "hen"
                password:
                  type: string
                  format: password
                  example: "demo123"
                workspace_id:
                  type: string
                  description: Optional workspace identifier
                  example: "hen-workspace"
            examples:
              basicLogin:
                summary: Basic login
                value:
                  username: "gerbov"
                  password: "Gerbov2024!Test"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              examples:
                success:
                  value:
                    token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
                    user_id: "hen-admin-001"
                    workspace_id: "hen-workspace"
                    expires_at: 1760457014
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # /api/auth/register:
  #   post:
  #     tags:
  #       - Authentication
  #     summary: Register new user
  #     description: User registration is disabled. Contact administrator for account creation.
  #     operationId: register
  #     requestBody:
  #       required: true
  #       content:
  #         application/json:
  #           schema:
  #             type: object
  #             required:
  #               - username
  #               - password
  #               - email
  #             properties:
  #               username:
  #                 type: string
  #                 minLength: 3
  #                 example: "farm_user_01"
  #               password:
  #                 type: string
  #                 format: password
  #                 minLength: 8
  #                 description: |
  #                   Password requirements:
  #                   - Minimum 8 characters
  #                   - At least one uppercase letter
  #                   - At least one lowercase letter
  #                   - At least one digit
  #                   - At least one special character
  #                 example: "SecurePass123!"
  #               email:
  #                 type: string
  #                 format: email
  #                 example: "user@farm.com"
  #               workspace_name:
  #                 type: string
  #                 description: Optional workspace name
  #                 example: "MyFarm"
  #     responses:
  #       '200':
  #         description: Registration successful
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/AuthResponse'
  #       '400':
  #         $ref: '#/components/responses/BadRequest'
  #       '409':
  #         description: Username or email already exists
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/ErrorResponse'

  /api/auth/profile:
    get:
      tags:
        - Authentication
      summary: Get user profile
      description: Retrieve authenticated user's profile information
      operationId: getProfile
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/items/local:
    post:
      tags:
        - Items
      summary: Create local item
      description: |
        Create a new item locally without immediate tokenization. The item receives a Local ID (LID)
        and remains in LocalOnly status until pushed to a circuit.

        **Important**: You must provide at least one identifier. Identifiers can be:
        - **Canonical** (globally unique): SISBOV, CPF, CAR, RFID
        - **Contextual** (locally unique): lote, safra, granja, talhao
      operationId: createLocalItem
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                identifiers:
                  type: array
                  description: Legacy identifier format (deprecated, use enhanced_identifiers)
                  items:
                    type: object
                    required:
                      - key
                      - value
                    properties:
                      key:
                        type: string
                      value:
                        type: string
                enhanced_identifiers:
                  type: array
                  description: Enhanced identifiers with namespace and type
                  items:
                    $ref: '#/components/schemas/EnhancedIdentifier'
                enriched_data:
                  type: object
                  description: Additional data about the item (JSON object)
                  additionalProperties: true
            examples:
              cattle:
                summary: Cattle with SISBOV
                value:
                  enhanced_identifiers:
                    - namespace: "bovino"
                      key: "sisbov"
                      value: "BR921180523565"
                      id_type: "Canonical"
                  enriched_data:
                    breed: "Nelore"
                    birth_date: "2023-05-15"
                    weight_kg: 450
                    farm_id: "FARM-001"
              soybean:
                summary: Soybean batch
                value:
                  enhanced_identifiers:
                    - namespace: "soja"
                      key: "lote"
                      value: "LOTE-2024-001"
                      id_type: "Contextual"
                    - namespace: "soja"
                      key: "safra"
                      value: "2024"
                      id_type: "Contextual"
                  enriched_data:
                    variety: "Monsoy 8372"
                    harvest_date: "2024-03-20"
                    quantity_kg: 50000
      responses:
        '200':
          description: Local item created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      local_id:
                        type: string
                        format: uuid
                        description: Local ID (LID) for this item
                      status:
                        type: string
                        enum: [LocalOnly]
              examples:
                success:
                  value:
                    success: true
                    data:
                      local_id: "12a0b56d-f478-4547-b796-792d6e0e81eb"
                      status: "LocalOnly"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/items/mapping/{local_id}:
    get:
      tags:
        - Items
      summary: Get LID-DFID mapping
      description: |
        Query the mapping between a Local ID (LID) and its corresponding DFID after tokenization.
        Status can be:
        - **LocalOnly**: Item not yet pushed to any circuit
        - **Pushed**: Item pushed and assigned a DFID
      operationId: getLidDfidMapping
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: local_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "12a0b56d-f478-4547-b796-792d6e0e81eb"
      responses:
        '200':
          description: Mapping retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      local_id:
                        type: string
                        format: uuid
                      dfid:
                        type: string
                        nullable: true
                        description: DFID assigned after circuit push (null if not yet pushed)
                      status:
                        type: string
                        enum: [LocalOnly, Pushed]
              examples:
                notPushed:
                  value:
                    success: true
                    data:
                      local_id: "12a0b56d-f478-4547-b796-792d6e0e81eb"
                      dfid: null
                      status: "LocalOnly"
                pushed:
                  value:
                    success: true
                    data:
                      local_id: "12a0b56d-f478-4547-b796-792d6e0e81eb"
                      dfid: "DFID-20251013-000001-CEEF"
                      status: "Pushed"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/circuits/{circuit_id}/push-local:
    post:
      tags:
        - Circuits
      summary: Push local item to circuit (tokenization)
      description: |
        Push a local item to a circuit for tokenization. This operation:
        1. Uploads item data to IPFS (via Pinata)
        2. Mints NFT on Stellar blockchain
        3. Updates IPCM contract with content pointer
        4. Assigns DFID through deduplication logic
        5. Records all transaction hashes in storage history

        **Important**: Circuit must have an adapter configured (e.g., StellarTestnetIpfs, StellarMainnetIpfs).
      operationId: pushLocalItem
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "187318ae-8f6d-4a03-aac1-bfc051f2d2ff"
          description: Circuit ID (obtained when creating or joining a circuit)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - local_id
                - requester_id
              properties:
                local_id:
                  type: string
                  format: uuid
                  description: Local ID obtained from POST /api/items/local
                requester_id:
                  type: string
                  description: User ID performing the push operation
                identifiers:
                  type: array
                  description: Enhanced identifiers (must include SISBOV for this circuit)
                  items:
                    type: object
                    required:
                      - namespace
                      - key
                      - value
                      - id_type
                    properties:
                      namespace:
                        type: string
                      key:
                        type: string
                      value:
                        type: string
                      id_type:
                        type: string
                        enum: [Canonical, Contextual]
            examples:
              push:
                value:
                  local_id: "12a0b56d-f478-4547-b796-792d6e0e81eb"
                  requester_id: "user-6a6f2c5d-df88-4e89-8194-2d4fe2790065"
                  identifiers:
                    - namespace: "bovino"
                      key: "sisbov"
                      value: "BR921180523565"
                      id_type: "Canonical"
                description: Include identifiers with SISBOV to meet circuit requirements
      responses:
        '200':
          description: Item pushed and tokenized successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      dfid:
                        type: string
                        description: Assigned DFID (new or existing)
                      status:
                        type: string
                        enum: [NewItemCreated, ExistingItemEnriched]
                      operation_id:
                        type: string
                        format: uuid
                      local_id:
                        type: string
                        format: uuid
              examples:
                newItem:
                  value:
                    success: true
                    data:
                      dfid: "DFID-20251013-000001-CEEF"
                      status: "NewItemCreated"
                      operation_id: "b67f14c7-9ec0-49ff-ae3d-b5cf04b2de0e"
                      local_id: "12a0b56d-f478-4547-b796-792d6e0e81eb"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Permission denied or adapter access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                adapterDenied:
                  value:
                    error: "Failed to set adapter config: Permission denied: Your tier (basic) does not have access to the StellarMainnetIpfs adapter"
        '404':
          $ref: '#/components/responses/NotFound'

  /api/items/{dfid}/storage-history:
    get:
      tags:
        - Storage
      summary: Get item storage history
      description: |
        Retrieve complete storage history for an item including all blockchain transactions,
        IPFS CIDs, and storage locations.
      operationId: getStorageHistory
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: dfid
          in: path
          required: true
          schema:
            type: string
          example: "DFID-20251013-000001-CEEF"
      responses:
        '200':
          description: Storage history retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  dfid:
                    type: string
                  records:
                    type: array
                    items:
                      $ref: '#/components/schemas/StorageRecord'
              examples:
                withStellar:
                  value:
                    success: true
                    dfid: "DFID-20251013-000001-CEEF"
                    records:
                      - adapter_type: "StellarTestnetIpfs"
                        network: "stellar-testnet"
                        nft_mint_tx: "c81ce1ccbdf4ffa334ab81b050ec670ba4277c877cae00d550932b9bd12fb272"
                        ipcm_update_tx: "88fb0f1a3a5039ea52f3237f988442be11de4225fdfc8ea79ad803370a27be04"
                        ipfs_cid: "QmPmK1dJR5TJaiknnM1gAHpUXM7eK9921kdc7TsuPW6Zsr"
                        ipfs_pinned: true
                        nft_contract: "CDOZEG35YQ7KYASQBUW2DVV7CIQZB5HMWAB2PWPUCHSTKSCD5ZUTPUW3"
                        storage_location: "Stellar { transaction_id: \"88fb0f1a...\", contract_address: \"CAALVDSF7R...\", asset_id: Some(\"QmPmK...\") }"
                        stored_at: "2025-10-13T15:50:24.345425842+00:00"
                        triggered_by: "circuit_push"
                        is_active: true
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/adapters:
    get:
      tags:
        - Adapters
      summary: List available adapters
      description: |
        Get list of storage adapters available to the authenticated user.
        Available adapters depend on user tier:
        - **Basic**: LocalLocal, LocalIpfs
        - **Professional**: + IpfsIpfs, StellarTestnetIpfs
        - **Enterprise**: + StellarMainnetIpfs, StellarMainnetStellarMainnet
      operationId: listAdapters
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Adapters retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  available_adapters:
                    type: array
                    items:
                      $ref: '#/components/schemas/AdapterInfo'
              examples:
                professional:
                  value:
                    available_adapters:
                      - adapter_type: "IpfsIpfs"
                        name: "IPFS + IPFS"
                        description: "IPFS storage for both items and events"
                        item_storage: "Ipfs"
                        event_storage: "Ipfs"
                        requires_blockchain: false
                        available: true
                      - adapter_type: "StellarTestnetIpfs"
                        name: "Stellar Testnet + IPFS"
                        description: "Stellar testnet NFTs with IPFS storage"
                        item_storage: "Stellar"
                        event_storage: "Ipfs"
                        requires_blockchain: true
                        available: true
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/circuits/{circuit_id}/post-actions:
    get:
      tags:
        - Webhooks
      summary: Get webhook settings
      description: Retrieve post-action webhook settings for a circuit (owner/admin only)
      operationId: getPostActionSettings
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Settings retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostActionSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    put:
      tags:
        - Webhooks
      summary: Update webhook settings
      description: Configure post-action webhook settings for a circuit (owner/admin only)
      operationId: updatePostActionSettings
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostActionSettingsUpdate'
      responses:
        '200':
          description: Settings updated successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/circuits/{circuit_id}/post-actions/webhooks:
    post:
      tags:
        - Webhooks
      summary: Create webhook
      description: Create a new webhook for circuit events (owner/admin only)
      operationId: createWebhook
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookCreate'
            examples:
              basicWebhook:
                summary: Basic webhook with bearer token
                value:
                  name: "ERP System Notification"
                  url: "https://erp.farm.com/api/defarm-webhook"
                  events:
                    - "ItemPushed"
                    - "ItemTokenized"
                  enabled: true
                  auth_type: "BearerToken"
                  auth_config:
                    token: "secret_token_here"
                  include_storage_details: true
                  include_item_metadata: true
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/circuits/{circuit_id}/post-actions/webhooks/{webhook_id}:
    get:
      tags:
        - Webhooks
      summary: Get webhook details
      description: Retrieve webhook configuration (owner/admin only)
      operationId: getWebhook
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    put:
      tags:
        - Webhooks
      summary: Update webhook
      description: Update webhook configuration (owner/admin only)
      operationId: updateWebhook
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookUpdate'
      responses:
        '200':
          description: Webhook updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      tags:
        - Webhooks
      summary: Delete webhook
      description: Delete a webhook configuration (owner/admin only)
      operationId: deleteWebhook
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Webhook deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/circuits/{circuit_id}/post-actions/webhooks/{webhook_id}/test:
    post:
      tags:
        - Webhooks
      summary: Test webhook
      description: Send a test payload to webhook URL (owner/admin only)
      operationId: testWebhook
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Test webhook fired successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  response_code:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/circuits/{circuit_id}/post-actions/deliveries:
    get:
      tags:
        - Webhooks
      summary: Get webhook delivery history
      description: Retrieve webhook delivery history with status and responses (owner/admin only)
      operationId: getWebhookDeliveries
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: circuit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Delivery history retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  deliveries:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookDelivery'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /api/auth/login
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key in format dfm_{32-characters}

  schemas:
    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT token for authentication
        user_id:
          type: string
          description: User identifier
        workspace_id:
          type: string
          nullable: true
          description: Workspace identifier
        expires_at:
          type: integer
          format: int64
          description: Unix timestamp when token expires

    UserProfile:
      type: object
      properties:
        user_id:
          type: string
        username:
          type: string
        email:
          type: string
          format: email
        created_at:
          type: integer
          format: int64
        workspace_id:
          type: string
          nullable: true

    EnhancedIdentifier:
      type: object
      required:
        - namespace
        - key
        - value
        - id_type
      properties:
        namespace:
          type: string
          description: Value chain namespace
          enum: [bovino, aves, suino, soja, milho, algodao, cafe, leite, generic]
          example: "bovino"
        key:
          type: string
          description: Identifier type
          example: "sisbov"
        value:
          type: string
          description: Identifier value
          example: "BR921180523565"
        id_type:
          type: string
          enum: [Canonical, Contextual]
          description: |
            - Canonical: Globally unique (SISBOV, CPF, CAR, RFID)
            - Contextual: Locally unique (lote, safra, granja)

    StorageRecord:
      type: object
      properties:
        adapter_type:
          type: string
          enum: [LocalLocal, LocalIpfs, IpfsIpfs, StellarTestnetIpfs, StellarMainnetIpfs, StellarMainnetStellarMainnet]
        network:
          type: string
          description: Blockchain network (e.g., stellar-testnet, stellar-mainnet)
        nft_mint_tx:
          type: string
          nullable: true
          description: NFT minting transaction hash
        ipcm_update_tx:
          type: string
          nullable: true
          description: IPCM update transaction hash
        ipfs_cid:
          type: string
          nullable: true
          description: IPFS Content Identifier
        ipfs_pinned:
          type: boolean
          description: Whether content is pinned on IPFS
        nft_contract:
          type: string
          nullable: true
          description: NFT contract address
        storage_location:
          type: string
          description: Full storage location details
        stored_at:
          type: string
          format: date-time
          description: Timestamp when stored
        triggered_by:
          type: string
          description: Operation that triggered storage (e.g., circuit_push)
        is_active:
          type: boolean
          description: Whether this is the current active storage

    AdapterInfo:
      type: object
      properties:
        adapter_type:
          type: string
          enum: [LocalLocal, LocalIpfs, IpfsIpfs, StellarTestnetIpfs, StellarMainnetIpfs, StellarMainnetStellarMainnet]
        name:
          type: string
        description:
          type: string
        item_storage:
          type: string
          enum: [Local, Ipfs, Stellar]
        event_storage:
          type: string
          enum: [Local, Ipfs, Stellar]
        requires_blockchain:
          type: boolean
        available:
          type: boolean

    PostActionSettings:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether post-action system is enabled for circuit
        webhooks:
          type: array
          items:
            $ref: '#/components/schemas/Webhook'

    PostActionSettingsUpdate:
      type: object
      properties:
        enabled:
          type: boolean
          description: Enable/disable post-action webhook system

    WebhookCreate:
      type: object
      required:
        - name
        - url
        - events
      properties:
        name:
          type: string
          description: Webhook name
          example: "ERP System Notification"
        url:
          type: string
          format: uri
          description: Webhook endpoint URL (HTTPS only for production)
          example: "https://erp.farm.com/api/defarm-webhook"
        events:
          type: array
          items:
            type: string
            enum: [ItemPushed, ItemApproved, ItemTokenized, ItemPublished]
          description: Events that trigger this webhook
        enabled:
          type: boolean
          default: true
        auth_type:
          type: string
          enum: [None, BearerToken, ApiKey, BasicAuth, CustomHeader]
          default: None
        auth_config:
          type: object
          description: Authentication configuration (varies by auth_type)
        retry_config:
          type: object
          properties:
            max_retries:
              type: integer
              default: 3
            initial_delay_ms:
              type: integer
              default: 1000
            max_delay_ms:
              type: integer
              default: 30000
            backoff_multiplier:
              type: number
              format: float
              default: 2.0
        include_storage_details:
          type: boolean
          default: false
          description: Include blockchain and IPFS details in payload
        include_item_metadata:
          type: boolean
          default: true
          description: Include item metadata in payload

    WebhookUpdate:
      type: object
      properties:
        name:
          type: string
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
            enum: [ItemPushed, ItemApproved, ItemTokenized, ItemPublished]
        enabled:
          type: boolean
        auth_type:
          type: string
          enum: [None, BearerToken, ApiKey, BasicAuth, CustomHeader]
        auth_config:
          type: object
        retry_config:
          type: object
        include_storage_details:
          type: boolean
        include_item_metadata:
          type: boolean

    Webhook:
      type: object
      properties:
        webhook_id:
          type: string
          format: uuid
        name:
          type: string
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        enabled:
          type: boolean
        auth_type:
          type: string
        retry_config:
          type: object
        include_storage_details:
          type: boolean
        include_item_metadata:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_triggered:
          type: string
          format: date-time
          nullable: true

    WebhookDelivery:
      type: object
      properties:
        delivery_id:
          type: string
          format: uuid
        webhook_id:
          type: string
          format: uuid
        event_type:
          type: string
        status:
          type: string
          enum: [Pending, Success, Failed, Retrying]
        response_code:
          type: integer
          nullable: true
        response_body:
          type: string
          nullable: true
        attempts:
          type: integer
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
        details:
          type: string
          description: Additional error details
          nullable: true

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalidIdentifiers:
              value:
                error: "At least one identifier is required"

    Unauthorized:
      description: Unauthorized - invalid or missing authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalidToken:
              value:
                error: "Invalid or expired token"

    Forbidden:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            adapterDenied:
              value:
                error: "Permission denied: Your tier (basic) does not have access to this adapter"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            itemNotFound:
              value:
                error: "Item not found"

    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            rateLimited:
              value:
                error: "Rate limit exceeded. Please try again in 3600 seconds."
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per window
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in current window
        X-RateLimit-Reset:
          schema:
            type: integer
            format: int64
          description: Unix timestamp when limit resets
        Retry-After:
          schema:
            type: integer
          description: Seconds until next allowed request
