# ðŸš€ DeFarm Engines Production Deployment Guide

Complete guide for deploying DeFarm Engines to production with PostgreSQL, Docker, and nginx.

## ðŸ“‹ Table of Contents

- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Detailed Setup](#detailed-setup)
- [Configuration](#configuration)
- [Deployment Options](#deployment-options)
- [SSL/TLS Setup](#ssltls-setup)
- [Monitoring & Maintenance](#monitoring--maintenance)
- [Troubleshooting](#troubleshooting)
- [Security Checklist](#security-checklist)

---

## Prerequisites

### Required Software

- **Docker** 20.10+ ([Install Docker](https://docs.docker.com/get-docker/))
- **Docker Compose** 2.0+ ([Install Compose](https://docs.docker.com/compose/install/))
- **Stellar CLI** ([Install Stellar CLI](https://developers.stellar.org/docs/tools/developer-tools/cli))
- **Git** (for cloning repository)

### Required Accounts & Credentials

- **Pinata Account** for IPFS storage ([Sign up](https://app.pinata.cloud/))
- **Stellar Wallets** (testnet and/or mainnet)
- **PostgreSQL** (included in Docker setup, or use external instance)

---

## Quick Start

### 1. Clone and Configure

```bash
# Clone repository
git clone https://github.com/your-org/defarm-rust-engine.git
cd defarm-rust-engine

# Copy environment template
cp .env.example .env

# Edit .env with your credentials
nano .env  # or vim, code, etc.
```

### 2. Configure Environment Variables

Edit `.env` and set at minimum:

```bash
# Required for production
JWT_SECRET=your-secure-random-jwt-secret-32-chars-minimum
DATABASE_URL=postgres://defarm:strong_password@postgres:5432/defarm
PINATA_API_KEY=your-pinata-api-key
PINATA_SECRET_KEY=your-pinata-secret-key
PINATA_JWT=your-pinata-jwt

# Stellar configuration (use your own wallets!)
STELLAR_TESTNET_SECRET=your-testnet-secret-key
STELLAR_MAINNET_SECRET_KEY=your-mainnet-secret-key
```

### 3. Deploy

```bash
# Run deployment script
./deploy.sh
```

That's it! Your API will be available at:
- **HTTP**: http://localhost
- **HTTPS**: https://localhost (self-signed cert, replace for production)
- **Health**: http://localhost/health

---

## Detailed Setup

### Step 1: Server Preparation

#### On Ubuntu/Debian:

```bash
# Update system
sudo apt-get update && sudo apt-get upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Install Stellar CLI
cargo install --locked stellar-cli
```

#### Configure Stellar Networks:

```bash
# Add testnet
stellar network add testnet \
  --rpc-url https://soroban-testnet.stellar.org \
  --network-passphrase "Test SDF Network ; September 2015"

# Add mainnet
stellar network add mainnet \
  --rpc-url https://soroban-mainnet.stellar.org \
  --network-passphrase "Public Global Stellar Network ; September 2015"

# Verify
stellar network ls
```

### Step 2: Environment Configuration

Create and configure `.env`:

```bash
cp .env.example .env
```

#### Security Settings

```bash
# Generate secure JWT secret
JWT_SECRET=$(openssl rand -base64 32)
echo "JWT_SECRET=$JWT_SECRET" >> .env

# Set strong database password
DB_PASSWORD=$(openssl rand -base64 16)
```

#### Database Configuration

For **Docker PostgreSQL** (included):
```bash
DATABASE_URL=postgres://defarm:${DB_PASSWORD}@postgres:5432/defarm
```

For **External PostgreSQL**:
```bash
DATABASE_URL=postgres://username:password@hostname:5432/database
```

#### IPFS/Pinata Setup

1. Sign up at [Pinata](https://app.pinata.cloud/)
2. Generate API key
3. Add to `.env`:

```bash
PINATA_API_KEY=your_api_key
PINATA_SECRET_KEY=your_secret_key
PINATA_JWT=your_jwt_token
```

#### Stellar Wallet Setup

**Testnet** (for testing):
```bash
# Generate testnet wallet
stellar keys generate testnet-admin

# Fund it with testnet XLM
stellar account fund testnet-admin --network testnet

# Get secret key
stellar keys show testnet-admin

# Add to .env
STELLAR_TESTNET_SECRET=S...
```

**Mainnet** (for production):
```bash
# Generate mainnet wallet
stellar keys generate mainnet-admin

# !!! IMPORTANT: Backup your secret key securely !!!
stellar keys show mainnet-admin

# Fund with real XLM (required for transactions)

# Add to .env
STELLAR_MAINNET_SECRET_KEY=S...
DEFARM_OWNER_WALLET=G...  # Your public key
```

### Step 3: SSL/TLS Configuration

#### Development (Self-Signed)

Automatically generated by `deploy.sh`:

```bash
./deploy.sh  # Creates self-signed cert
```

#### Production (Let's Encrypt)

**Option A: Manual Setup**

```bash
# Install Certbot
sudo apt-get install certbot

# Generate certificate
sudo certbot certonly --standalone -d yourdomain.com

# Copy to nginx directory
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem nginx/ssl/
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem nginx/ssl/
```

**Option B: Automated with Docker**

Add to `docker-compose.yml`:

```yaml
  certbot:
    image: certbot/certbot
    volumes:
      - ./nginx/ssl:/etc/letsencrypt
      - ./nginx/certbot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
```

### Step 4: Database Initialization

The deployment script automatically:
1. Creates PostgreSQL container
2. Runs migrations (via Refinery)
3. Initializes adapter configs
4. Creates admin user

**Manual initialization** (if needed):

```bash
# Connect to database
docker-compose exec postgres psql -U defarm

# Run migrations manually
docker-compose exec api /app/defarm-api migrate

# Check database
\dt  # List tables
```

### Step 5: Deploy

```bash
# Deploy with script
./deploy.sh

# Or manually
docker-compose up -d

# Check logs
docker-compose logs -f
```

---

## Configuration

### Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | Yes | - | PostgreSQL connection string |
| `JWT_SECRET` | Yes | - | Secret for JWT tokens (32+ chars) |
| `PINATA_API_KEY` | Yes | - | Pinata IPFS API key |
| `PINATA_SECRET_KEY` | Yes | - | Pinata secret key |
| `STELLAR_TESTNET_SECRET` | No | - | Testnet wallet secret |
| `STELLAR_MAINNET_SECRET_KEY` | No | - | Mainnet wallet secret |
| `DATABASE_POOL_SIZE` | No | 16 | Connection pool size |

### Docker Compose Configuration

Edit `docker-compose.yml` for custom settings:

```yaml
services:
  api:
    environment:
      RUST_LOG: debug  # Change log level
    ports:
      - "8080:3000"    # Change port mapping
```

---

## Deployment Options

### Option 1: All-in-One Docker (Recommended)

Uses included `docker-compose.yml`:

```bash
./deploy.sh
```

**Includes:**
- PostgreSQL
- API Server
- Nginx Reverse Proxy

### Option 2: External Database

1. Update `.env`:
```bash
DATABASE_URL=postgres://user:pass@external-db.com:5432/defarm
```

2. Comment out postgres service in `docker-compose.yml`

3. Deploy:
```bash
docker-compose up -d
```

### Option 3: Kubernetes

See `k8s/` directory for Kubernetes manifests (TODO: create these).

### Option 4: Bare Metal

```bash
# Build binary
cargo build --release

# Configure environment
export DATABASE_URL=postgres://...

# Run migrations
refinery migrate -c refinery.toml

# Run server
./target/release/defarm-api
```

---

## SSL/TLS Setup

### Let's Encrypt (Recommended)

```bash
# Install certbot
sudo apt-get install certbot python3-certbot-nginx

# Get certificate
sudo certbot --nginx -d yourdomain.com

# Auto-renewal (cron)
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo tee -a /etc/crontab
```

### Custom Certificate

```bash
# Copy your certs
cp your-fullchain.pem nginx/ssl/fullchain.pem
cp your-privkey.pem nginx/ssl/privkey.pem

# Restart nginx
docker-compose restart nginx
```

---

## Monitoring & Maintenance

### Health Checks

```bash
# API health
curl http://localhost/health

# Container health
docker-compose ps

# Check specific service
docker-compose exec api curl localhost:3000/health
```

### Logs

```bash
# All logs
docker-compose logs -f

# API logs only
docker-compose logs -f api

# PostgreSQL logs
docker-compose logs -f postgres

# Nginx access logs
docker-compose exec nginx tail -f /var/log/nginx/access.log
```

### Database Backups

**Automated daily backup**:

```bash
# Create backup script
cat > backup-db.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
docker-compose exec -T postgres pg_dump -U defarm defarm > backup_${DATE}.sql
gzip backup_${DATE}.sql
# Upload to S3 or your backup solution
EOF

chmod +x backup-db.sh

# Add to crontab
echo "0 2 * * * /path/to/backup-db.sh" | crontab -
```

### Updates

```bash
# Pull latest code
git pull

# Rebuild and restart
docker-compose build --no-cache
docker-compose up -d

# Check logs
docker-compose logs -f api
```

---

## Troubleshooting

### API Won't Start

**Check logs**:
```bash
docker-compose logs api
```

**Common issues**:
- Database not ready â†’ Wait 30s and restart
- Missing env vars â†’ Check `.env`
- Port conflict â†’ Change port in `docker-compose.yml`

### Database Connection Errors

```bash
# Check PostgreSQL is running
docker-compose ps postgres

# Test connection
docker-compose exec postgres psql -U defarm -d defarm

# Check credentials in .env
grep DATABASE_URL .env
```

### Stellar Integration Errors

```bash
# Check CLI is configured
stellar network ls

# Test network connectivity
stellar contract invoke --help

# Verify contract addresses
echo $STELLAR_TESTNET_IPCM_CONTRACT
```

### SSL Certificate Errors

```bash
# Check certificate files
ls -la nginx/ssl/

# Verify certificate
openssl x509 -in nginx/ssl/fullchain.pem -text -noout

# Test HTTPS
curl -k https://localhost/health
```

---

## Security Checklist

### Pre-Production

- [ ] Strong `JWT_SECRET` (32+ random characters)
- [ ] Strong database password
- [ ] SSL/TLS certificates (not self-signed)
- [ ] Firewall rules configured (only 80, 443, SSH)
- [ ] Separate Stellar wallets for testnet/mainnet
- [ ] Secrets stored in vault (not `.env` in git)
- [ ] Database backups configured
- [ ] Monitoring/alerting set up

### Production Hardening

- [ ] Enable PostgreSQL SSL
- [ ] Implement rate limiting (done in nginx.conf)
- [ ] Set up fail2ban or similar
- [ ] Enable audit logging
- [ ] Regular security updates
- [ ] Penetration testing
- [ ] DDoS protection (Cloudflare, etc.)
- [ ] Rotate credentials regularly

### Stellar Security

- [ ] Mainnet secret keys stored securely (Hardware wallet, KMS)
- [ ] Different keys for testnet/mainnet
- [ ] Monitor transaction costs
- [ ] Set spending limits if possible
- [ ] Regular security audits of smart contracts

---

## Performance Tuning

### Database

```sql
-- Increase connection limits (if needed)
ALTER SYSTEM SET max_connections = 100;

-- Tune cache sizes
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
```

### API

```yaml
# docker-compose.yml
services:
  api:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
```

### Nginx

```nginx
# nginx.conf
worker_processes 4;
worker_connections 2048;
```

---

## Support & Resources

- **Documentation**: [PRODUCTION_DEPLOYMENT_PLAN.md](./PRODUCTION_DEPLOYMENT_PLAN.md)
- **Deployment Guide**: [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)
- **API Documentation**: http://localhost/api/
- **Stellar Docs**: https://developers.stellar.org/
- **Docker Docs**: https://docs.docker.com/

---

## License

[Your License]

## Contact

[Your Contact Info]
